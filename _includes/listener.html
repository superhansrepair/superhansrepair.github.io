<script type = "application/javascript">

var FUDGE = 0.8; //(how far towards bottom right corner)
var ANIMATION_RADIUS = 9 //(this is the animation start radius)
var NORMAL_RADIUS = 3 //(this is the ... you know, radius, of the circle)
var OVER_RADIUS = 4 //(during hover)
var COLOUR = "red" // (circle colour)
var OPACITY = 0.6 // (how solid the circle fill is)
var ENTRY_ANIMATION //tracks to see if in progress

var elementsOfInterest = [
  {
    id : "path3427_3_",
    name : "wheel"
  },
  {
    id : "path3267_3_",
    name : "wing-mirror"
  },
  {
    id : "path4289_3_",
    name : "exhaust"
  },
  {
    id : "path3486_8_",
    name : "headlight"
  }
]

function attachHandlerTo({id, name}){
  console.log(id,name)
  var element = document.getElementById(id)
  if(null!== element){

      var svg = d3.select("svg")
      svg.on("mousemove",entryAnimation)

      var part = d3.select("#"+id);
      var boundingBox = part.node().getBBox()

      var additions = svg
      .append("g")
      .attr("transform", "translate("+
        (boundingBox.x+boundingBox.width*FUDGE)+","+
        (boundingBox.y+boundingBox.height*FUDGE)+")"
      )

      var circle = additions
      .append("circle")
      .attr("class","circleOfInterest")
      .style("fill",COLOUR)
      .attr("r",ANIMATION_RADIUS)
      .attr("opacity",0)

      var plus = additions
      .append("text")
      .attr("class","plusSign")
      .style("fill","white")
      .attr("text-anchor","middle")
      .attr("font-size","0.3em")
      .attr("dy","0.3em")
      .attr("opacity",0)
      .text("+")
      .attr("transform","rotate("+900+")")


      var over = getListener(true,{circle,plus});
      var out = getListener(false,{circle,plus});

      circle
      .on("mouseover",over)
      .on("mouseout",out)
      .on("click",over)

      plus
      .on("mouseover",over)
      .on("mouseout",out)
      .on("click",over)

  } else {
    console.error("I couldn't find",name,"using",id,"... Sad")
  }
}

function getListener(over,bits){
  return (over ?
  function (){
    bits.circle
    .attr("r",OVER_RADIUS)
    .attr("opacity",1)
  } :
  function (){
    bits.circle
    .transition()
    .duration(500)
    .attr("r",3)
    .attr("opacity",OPACITY)
 })
}

elementsOfInterest.forEach((element)=>{
  attachHandlerTo(element)
})

function entryAnimation(){
  if(!ENTRY_ANIMATION){
    ENTRY_ANIMATION = true
    d3.selectAll(".circleOfInterest")
    .transition()
    .duration(750)
    .ease(d3.easeLinear)
    .attr("opacity",OPACITY)
    .attr("r",NORMAL_RADIUS)

    d3.selectAll(".plusSign")
    .transition()
    .duration(750)
    .ease(d3.easeLinear)
    .attr("opacity",1)
    .attr("transform","rotate("+0+")")

    d3.select("svg")
    .on("mousemove",()=>{})
  }
}

</script>
